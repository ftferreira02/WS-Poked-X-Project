{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'evolution-chain.css' %}">
{% endblock %}

{% block content %}

<script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
<link href="https://unpkg.com/vis-network/styles/vis-network.min.css" rel="stylesheet" type="text/css" />

<div class="content" typeof="schema:WebPage" resource="#evolution-chains">
    <h1 property="schema:name">All Evolution Chains</h1>
    <p style="margin-bottom: 1rem;" property="schema:description">
        Explore how Pokémon evolve from one form to another! Click on any Pokémon to view full stats and abilities.
    </p>
    <div id="evolution-network" style="width: 100%; height: 800px; border: 1px solid lightgray;" 
         typeof="pokemon:EvolutionNetwork" 
         property="pokemon:visualization">
    </div>
</div>
  
{% endblock %}

{% block extra_scripts %}
<script>
    // Add RDFa annotations dynamically to nodes
    const nodesData = JSON.parse('{{ nodes_json|safe }}');
    nodesData.forEach(node => {
        node.title = `<div typeof="pokemon:Pokemon" resource="pokemon:${node.id}">
                        <span property="schema:name">${node.label}</span>
                     </div>`;
    });
    
    const nodes = new vis.DataSet(nodesData);
    
    // Add RDFa annotations to edges (evolution relationships)
    const edgesData = JSON.parse('{{ edges_json|safe }}');
    edgesData.forEach(edge => {
        edge.title = `<div typeof="pokemon:Evolution" resource="pokemon:evolution_${edge.from}_${edge.to}">
                        <span property="pokemon:evolves_from" resource="pokemon:${edge.from}"></span>
                        <span property="pokemon:evolves_to" resource="pokemon:${edge.to}"></span>
                     </div>`;
    });
    
    const edges = new vis.DataSet(edgesData);
  
    const container = document.getElementById("evolution-network");
    const data = { nodes, edges };
    const options = {
      layout: {
        improvedLayout: true // enables spring-like force layout
      },
      interaction: { hover: true },
      physics: {
        enabled: true,
        solver: "forceAtlas2Based",  // circular-looking spread
        forceAtlas2Based: {
            gravitationalConstant: -50,
            centralGravity: 0.01,
            springLength: 100,
            springConstant: 0.08
        },
        stabilization: {
            iterations: 200
        }
        }
    };
  
    const network = new vis.Network(container, data, options);
  
    // Click to go to Pokémon details page
    network.on("click", function (params) {
      if (params.nodes.length > 0) {
        const id = params.nodes[0];
        window.location.href = `/pokemon/stats/${id}/`;  // adjust if your URL pattern is different
      }
    });
  </script>
  
{% endblock %}
