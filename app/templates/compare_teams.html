{% extends 'base.html' %}
{% load static %}

{% block title %}Compare Teams{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'compare_teams.css' %}">
{% endblock %}

{% block content %}
<div class="content" typeof="schema:WebPage" resource="#team-comparison">
  <h1 property="schema:name">Compare Pokémon Teams</h1>
  <p class="description" property="schema:description">
    Compare two teams of up to 6 Pokémon each. Analyze their offensive and defensive coverage, 
    and see how well-balanced their roles are.
  </p>

  <div class="teams-container">
    <div class="team-section" typeof="pokemon:Team" resource="#team1">
      <h2>Team 1</h2>
      <div class="team-balance">
        <div class="balance-score" id="team1-balance">-</div>
        <div class="balance-label">Team Balance Score</div>
      </div>
      <div class="team-selection">
        <div class="team-limit">
          <span>Team Size:</span>
          <span class="team-limit-count" id="team1-count">0/6</span>
        </div>
        <div class="search-box" id="team1-search-box">
          <input type="text" class="pokemon-search" id="team1-search" placeholder="Search Pokémon..." autocomplete="off">
          <div class="team-limit-warning" id="team1-warning">Team is full! Remove a Pokémon to add more.</div>
          <div class="suggestions" id="team1-suggestions"></div>
        </div>
        <div class="selected-team" id="team1-pokemon"></div>
      </div>
      <div class="team-analysis" id="team1-analysis">
        <div class="coverage">
          <h3>Type Coverage</h3>
          <div class="coverage-section">
            <h4>Offensive Coverage</h4>
            <div class="type-list" id="team1-offensive"></div>
          </div>
          <div class="coverage-section">
            <h4>Defensive Coverage</h4>
            <div class="type-list" id="team1-defensive"></div>
          </div>
        </div>
        <div class="roles">
          <h3>Team Roles</h3>
          <div class="roles-list" id="team1-roles"></div>
        </div>
        <div class="waiting-message">Waiting for comparison...</div>
      </div>
    </div>

    <div class="vs-section">
      <div class="pokeball-divider">
        <img src="https://raw.githubusercontent.com/replyre/poke-info/main/search.png" alt="VS">
      </div>
    </div>

    <div class="team-section" typeof="pokemon:Team" resource="#team2">
      <h2>Team 2</h2>
      <div class="team-balance">
        <div class="balance-score" id="team2-balance">-</div>
        <div class="balance-label">Team Balance Score</div>
      </div>
      <div class="team-selection">
        <div class="team-limit">
          <span>Team Size:</span>
          <span class="team-limit-count" id="team2-count">0/6</span>
        </div>
        <div class="search-box" id="team2-search-box">
          <input type="text" class="pokemon-search" id="team2-search" placeholder="Search Pokémon..." autocomplete="off">
          <div class="team-limit-warning" id="team2-warning">Team is full! Remove a Pokémon to add more.</div>
          <div class="suggestions" id="team2-suggestions"></div>
        </div>
        <div class="selected-team" id="team2-pokemon"></div>
      </div>
      <div class="team-analysis" id="team2-analysis">
        <div class="coverage">
          <h3>Type Coverage</h3>
          <div class="coverage-section">
            <h4>Offensive Coverage</h4>
            <div class="type-list" id="team2-offensive"></div>
          </div>
          <div class="coverage-section">
            <h4>Defensive Coverage</h4>
            <div class="type-list" id="team2-defensive"></div>
          </div>
        </div>
        <div class="roles">
          <h3>Team Roles</h3>
          <div class="roles-list" id="team2-roles"></div>
        </div>
        <div class="waiting-message">Waiting for comparison...</div>
      </div>
    </div>
  </div>

  <button id="compare-button" class="compare-btn" disabled>Compare Teams</button>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const MAX_TEAM_SIZE = 6;
    
    // Team data structure
    const teams = {
      team1: [],
      team2: []
    };

    // Function to update team count display
    function updateTeamCount(teamId) {
      const count = teams[teamId].length;
      const countElement = document.getElementById(`${teamId}-count`);
      const searchBox = document.getElementById(`${teamId}-search-box`);
      const warningElement = document.getElementById(`${teamId}-warning`);
      
      countElement.textContent = `${count}/6`;
      
      if (count >= MAX_TEAM_SIZE) {
        countElement.classList.add('full');
        searchBox.classList.add('disabled');
        warningElement.classList.add('show');
        document.getElementById(`${teamId}-search`).disabled = true;
      } else {
        countElement.classList.remove('full');
        searchBox.classList.remove('disabled');
        warningElement.classList.remove('show');
        document.getElementById(`${teamId}-search`).disabled = false;
      }
    }

    // Function to add Pokemon to team
    function addPokemonToTeam(pokemon, teamId) {
      if (teams[teamId].length >= MAX_TEAM_SIZE) {
        return;
      }
      
      if (teams[teamId].some(p => p.id === pokemon.id)) {
        return;
      }

      teams[teamId].push(pokemon);
      updateTeamDisplay(teamId);
      updateTeamCount(teamId);
      updateCompareButton();

      // Clear search
      document.getElementById(`${teamId}-search`).value = '';
      document.getElementById(`${teamId}-suggestions`).style.display = 'none';
    }

    // Function to remove Pokemon from team
    function removePokemonFromTeam(pokemonId, teamId) {
      teams[teamId] = teams[teamId].filter(p => p.id !== pokemonId);
      updateTeamDisplay(teamId);
      updateTeamCount(teamId);
      updateCompareButton();
    }

    // Function to update team display
    function updateTeamDisplay(teamId) {
      const teamDiv = document.getElementById(`${teamId}-pokemon`);
      teamDiv.innerHTML = '';

      teams[teamId].forEach(pokemon => {
        const div = document.createElement('div');
        div.className = 'selected-pokemon';
        div.innerHTML = `
          <img src="${pokemon.imageUrl}" alt="${pokemon.name}" class="pokemon-icon">
          <span>${pokemon.name}</span>
          <button class="remove-btn" onclick="removePokemonFromTeam(${pokemon.id}, '${teamId}')">&times;</button>
        `;
        teamDiv.appendChild(div);
      });
    }

    // Function to update compare button state
    function updateCompareButton() {
      const button = document.getElementById('compare-button');
      button.disabled = teams.team1.length === 0 || teams.team2.length === 0;
    }

    // Initialize team counts
    ['team1', 'team2'].forEach(teamId => {
      updateTeamCount(teamId);
    });

    // Debounce function to limit API calls
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Function to search Pokemon via AJAX
    async function searchPokemon(query) {
      try {
        const response = await fetch(`/pokemon/search/ajax/?query=${encodeURIComponent(query)}`);
        const data = await response.json();
        return data.results;
      } catch (error) {
        console.error('Error searching Pokemon:', error);
        return [];
      }
    }

    // Function to show suggestions
    function showSuggestions(results, suggestionsDiv, teamId) {
      suggestionsDiv.innerHTML = '';
      
      if (results.length === 0) {
        suggestionsDiv.style.display = 'none';
        return;
      }

      results.forEach(pokemon => {
        if (teams[teamId].some(p => p.id === pokemon.id)) return;

        const div = document.createElement('div');
        div.className = 'suggestion-item';
        div.innerHTML = `
          <img src="${pokemon.imageUrl}" alt="${pokemon.name}" class="pokemon-icon">
          <span class="pokemon-name">${pokemon.name}</span>
          <div class="type-badges">
            <span class="type ${pokemon.primaryType.toLowerCase()}">${pokemon.primaryType}</span>
            ${pokemon.secondaryType ? 
              `<span class="type ${pokemon.secondaryType.toLowerCase()}">${pokemon.secondaryType}</span>` : 
              ''}
          </div>
        `;
        div.onclick = () => addPokemonToTeam(pokemon, teamId);
        suggestionsDiv.appendChild(div);
      });

      suggestionsDiv.style.display = 'block';
    }

    // Event listeners for search inputs
    ['team1', 'team2'].forEach(teamId => {
      const searchInput = document.getElementById(`${teamId}-search`);
      const suggestionsDiv = document.getElementById(`${teamId}-suggestions`);
      
      searchInput.addEventListener('input', debounce(async (e) => {
        const query = e.target.value.trim();
        if (query.length < 2) {
          suggestionsDiv.style.display = 'none';
          return;
        }
        
        const results = await searchPokemon(query);
        showSuggestions(results, suggestionsDiv, teamId);
      }, 300));
    });

    // Hide suggestions when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.search-box')) {
        document.querySelectorAll('.suggestions').forEach(el => {
          el.style.display = 'none';
        });
      }
    });

    // Compare button click handler
    document.getElementById('compare-button').addEventListener('click', async () => {
      try {
        const response = await fetch('/compare/teams/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({
            team1: teams.team1.map(p => p.id),
            team2: teams.team2.map(p => p.id)
          })
        });

        const data = await response.json();
        updateTeamAnalysis('team1', data.team1);
        updateTeamAnalysis('team2', data.team2);
      } catch (error) {
        console.error('Error comparing teams:', error);
      }
    });

    // Function to update team analysis display
    function updateTeamAnalysis(teamId, analysis) {
      // Hide waiting message
      document.querySelector(`#${teamId}-analysis .waiting-message`).style.display = 'none';

      // Update offensive coverage
      const offensiveDiv = document.getElementById(`${teamId}-offensive`);
      offensiveDiv.innerHTML = analysis.offensive_coverage.map(type => 
        `<span class="type ${type.toLowerCase()}">${type}</span>`
      ).join('');

      // Update defensive coverage
      const defensiveDiv = document.getElementById(`${teamId}-defensive`);
      defensiveDiv.innerHTML = analysis.defensive_coverage.map(type => 
        `<span class="type ${type.toLowerCase()}">${type}</span>`
      ).join('');

      // Update roles
      const rolesDiv = document.getElementById(`${teamId}-roles`);
      rolesDiv.innerHTML = Object.entries(analysis.roles).map(([role, count]) => `
        <div class="role-item">
          <span class="role-name">${role}</span>
          <span class="role-count">${count}</span>
        </div>
      `).join('');

      // Update balance score
      document.getElementById(`${teamId}-balance`).textContent = analysis.balance_score;
    }

    // Helper function to get CSRF token
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    // Make removePokemonFromTeam available globally
    window.removePokemonFromTeam = removePokemonFromTeam;
  });
</script>
{% endblock %} 