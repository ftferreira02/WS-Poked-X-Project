{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'compare.css' %}">
{% endblock %}


{% block content %}
<div class="content" typeof="schema:WebPage" resource="#comparison">
  <h1 property="schema:name">Compare Pok√©mon Sizes</h1>

<form method="post" style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;" typeof="schema:SearchAction">
  {% csrf_token %}
  <input type="text" id="pokemon-search" placeholder="Search Pok√©mon..." autocomplete="off" property="schema:query-input">
  <input type="hidden" name="pokemons" id="selected-pokemons">
  <button type="submit" class="compare-btn">Compare</button>
</form>

<div id="suggestions"></div>

<div id="selected-list" class="selected-pokeballs" typeof="pokemon:ComparisonList">
  {% if selected_pokemons %}
    {% for p in selected_pokemons %}
      <div class="pokeball-wrapper" data-id="{{ p.number }}" title="{{ p.name }}" typeof="pokemon:Pokemon" resource="pokemon:{{ p.number }}">
        <button type="button" class="pokeball-button">
          <img src="https://raw.githubusercontent.com/replyre/poke-info/main/search.png" alt="Pok√©ball">
        </button>
        <img src="{{ p.image_url }}" class="pokemon-inside" alt="{{ p.name }}" property="schema:image">
      </div>
    {% endfor %}
  {% else %}
    <div class="empty-message">
      <img src="https://raw.githubusercontent.com/replyre/poke-info/main/search.png" alt="Pok√©ball" style="height: 40px; vertical-align: middle;">
      <span style="margin-left: 10px;">
        Select Pok√©mon above to compare their sizes!
      </span>
    </div>
  {% endif %}
</div>

  {% if pokemons %}
    <hr>
    <h2>Size Comparison</h2>
    <div class="comparison-wrapper" data-height="{{ max_display_height }}" typeof="pokemon:SizeComparison">
      <div class="ruler-grid">
        {% for tick in tick_data %}
          <div class="ruler-line" data-top="{{ tick.top_px|floatformat:0 }}">
            <span property="schema:value">{{ tick.label }} m</span>
          </div>
        {% endfor %}
      </div>
    
      <div class="comparison-container">
        {% for p in pokemons %}
          <div class="pokemon-details" typeof="pokemon:Pokemon" resource="pokemon:{{ p.number }}">
            <img class="pokemon-image" src="{{ p.image_url }}" alt="{{ p.name }}" data-height="{{ p.scaled_height }}" property="schema:image">
            <div class="pokemon-details-info">
                <strong property="schema:identifier">#{{ p.number }}</strong>
                <span property="schema:name">{{ p.name }}</span><br>
                Height: <span property="schema:height">{{ p.height }} m</span><br>
                Weight: <span property="schema:weight">{{ p.weight }} kg</span>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  // Set height CSS variable from data attribute
  const wrapper = document.querySelector('.comparison-wrapper');
  if (wrapper) {
    wrapper.style.setProperty('--height', wrapper.dataset.height);
  }

  // Set ruler line positions
  document.querySelectorAll('.ruler-line').forEach(line => {
    line.style.setProperty('--top-px', `${line.dataset.top}px`);
  });

  // Set pokemon image heights
  document.querySelectorAll('.pokemon-image').forEach(img => {
    img.style.setProperty('--scaled-height', img.dataset.height);
  });

  const allPokemons = JSON.parse('{{ form.fields.pokemons.choices|safe|escapejs }}').map(p => ({
    number: p[0],
    name: p[1],
    image_url: `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${p[0]}.png`
  }));
</script>

<script>
  const searchInput = document.getElementById('pokemon-search');
  const suggestionsDiv = document.getElementById('suggestions');
  const selectedList = document.getElementById('selected-list');
  const hiddenInput = document.getElementById('selected-pokemons');
  
  let selectedPokemons = [];
  
  searchInput.addEventListener('input', () => {
      const query = searchInput.value.toLowerCase();
      suggestionsDiv.innerHTML = "";
  
      if (!query) return;
  
      const matches = allPokemons.filter(p => p.name.toLowerCase().includes(query) && !selectedPokemons.includes(p.number)).slice(0, 5);

      console.log("üîé Query:", query);
      console.log("üéØ Matches:", matches);
      
      matches.forEach(pokemon => {
        const div = document.createElement('div');
        div.classList.add('suggestion');
        div.innerHTML = `
          <img src="${pokemon.image_url}"
              alt="${pokemon.name}"
              style="height: 20px; vertical-align: middle; margin-right: 8px;">
          ${pokemon.name}`;
        div.onclick = () => addPokemon(pokemon);
        suggestionsDiv.appendChild(div);
      });
  });
  
  function addPokemon(pokemon) {
      if (selectedPokemons.length >= 5) return;
      if (selectedPokemons.includes(pokemon.number)) return;

      selectedPokemons.push(pokemon.number);
  
      const wrapper = document.createElement('div');
      wrapper.classList.add('pokeball-wrapper');
      wrapper.title = pokemon.name;

      const button = document.createElement('button');
      button.type = "button";
      button.classList.add('pokeball-button');

      const backgroundImg = document.createElement('img');
      backgroundImg.src = "https://raw.githubusercontent.com/replyre/poke-info/main/search.png";
      backgroundImg.alt = "Pok√©ball";

      const spriteImg = document.createElement('img');
      spriteImg.src = pokemon.image_url;
      spriteImg.alt = pokemon.name;
      spriteImg.classList.add('pokemon-inside');

      button.appendChild(backgroundImg);
      wrapper.appendChild(button);
      wrapper.appendChild(spriteImg);

      wrapper.onclick = () => {
          selectedPokemons = selectedPokemons.filter(n => n !== pokemon.number);
          wrapper.remove();
          hiddenInput.value = selectedPokemons.join(',');
      };

      selectedList.appendChild(wrapper);
      hiddenInput.value = selectedPokemons.join(',');
    
      searchInput.value = '';
      suggestionsDiv.innerHTML = '';
  }

  // Attach click handlers to server-rendered Pok√©balls on page load
  window.addEventListener('DOMContentLoaded', () => {
    // Rebuild selectedPokemons list from rendered pokeballs
    document.querySelectorAll('.pokeball-wrapper').forEach(wrapper => {
      const name = wrapper.getAttribute('title');
      const sprite = wrapper.querySelector('.pokemon-inside');
      const number = wrapper.dataset.id;
      
      if (number && !selectedPokemons.includes(number)) {
        selectedPokemons.push(number);
        wrapper.addEventListener('click', () => {
          selectedPokemons = selectedPokemons.filter(n => n !== number);
          wrapper.remove();
          hiddenInput.value = selectedPokemons.join(',');
        });
      }
    });

    // Set hidden input value
    hiddenInput.value = selectedPokemons.join(',');
  });

  // Helper to extract ID from sprite URL
  function extractPokemonId(url) {
    const match = url.match(/\/(\d+)\.png$/);
    return match ? match[1] : null;
  }

  </script>
{% endblock %}