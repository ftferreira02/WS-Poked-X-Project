{% extends 'base.html' %} 
{% load static %} 
{% block title %}Select Pok√©mon{% endblock %} 

{% block extra_css %}
<link rel="stylesheet" href="{% static 'battle.css' %}" />
<link rel="stylesheet" href="{% static 'pokemon_selection.css' %}" />
<style>
.best-match-container {
  margin-top: 15px;
  text-align: center;
}

.best-match-button {
  background: linear-gradient(135deg, #f39c12, #e67e22);
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 25px;
  font-weight: bold;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);
}

.best-match-button:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(243, 156, 18, 0.4);
}

.best-match-button:disabled {
  background: #bdc3c7;
  cursor: not-allowed;
  box-shadow: none;
}

.best-match-loading {
  background: #3498db;
  animation: pulse 1.5s infinite;
}

@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.6; }
  100% { opacity: 1; }
}

.match-info {
  margin-top: 10px;
  padding: 10px;
  background: rgba(46, 204, 113, 0.1);
  border-radius: 8px;
  border-left: 4px solid #2ecc71;
  font-size: 12px;
  display: none;
}

.error-info {
  background: rgba(231, 76, 60, 0.1);
  border-left-color: #e74c3c;
  color: #c0392b;
}

.vs-indicator {
  font-size: 48px;
  font-weight: bold;
  color: #e74c3c;
  margin: 20px 0;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
  animation: bounce 2s infinite;
}

@keyframes bounce {
  0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
  40% { transform: translateY(-10px); }
  60% { transform: translateY(-5px); }
}
</style>
{% endblock %} 

{% block body_class %}selection-page{% endblock %} 

{% block content %}
<div class="spacer"></div>
<!-- Pok√©mon Selection Page -->
<div class="selection-container">
  <h1 class="selection-title">Choose Your Pokemon</h1>
  
  <form method="post" action="{% url 'pokemon_selection' %}" id="pokemon-selection-form" autocomplete="off">
    {% csrf_token %}
    <div class="pokemon-selection-form">
      <div class="selection-card">
        <h2>First Pokemon</h2>
        <div class="selection-input-container">
          {{ form.pokemon1 }}
          <div id="suggestions1" class="suggestions-container"></div>
          <div id="selected-pokemon1" class="selected-pokemon"></div>
        </div>
        {{ form.pokemon1_id }}
        <div class="pokemon-preview" id="preview1"></div>
        
        <div class="best-match-container">
          <button type="button" class="best-match-button" id="best-match-btn" disabled>
            üéØ Find Best Match
          </button>
          <div id="match-info" class="match-info"></div>
        </div>
      </div>
      
      <div class="vs-indicator" id="vs-indicator" style="display: none;">VS</div>
      
      <div class="selection-card">
        <h2>Second Pokemon</h2>
        <div class="selection-input-container">
          {{ form.pokemon2 }}
          <div id="suggestions2" class="suggestions-container"></div>
          <div id="selected-pokemon2" class="selected-pokemon"></div>
        </div>
        {{ form.pokemon2_id }}
        <div class="pokemon-preview" id="preview2"></div>
      </div>
      
      <button type="submit" class="battle-button" id="battle-button" disabled>
        Start Battle!
      </button>
    </div>
  </form>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Pokemon data from the server
    const pokemonData = {{ pokemon_data_json|safe }};
    
    // Elements
    const input1 = document.querySelector('[name="pokemon1"]');
    const input2 = document.querySelector('[name="pokemon2"]');
    const hiddenInput1 = document.querySelector('[name="pokemon1_id"]');
    const hiddenInput2 = document.querySelector('[name="pokemon2_id"]');
    const suggestions1 = document.getElementById('suggestions1');
    const suggestions2 = document.getElementById('suggestions2');
    const selectedPokemon1 = document.getElementById('selected-pokemon1');
    const selectedPokemon2 = document.getElementById('selected-pokemon2');
    const preview1 = document.getElementById('preview1');
    const preview2 = document.getElementById('preview2');
    const battleButton = document.getElementById('battle-button');
    const bestMatchBtn = document.getElementById('best-match-btn');
    const matchInfo = document.getElementById('match-info');
    const vsIndicator = document.getElementById('vs-indicator');
    
    // Function to filter pokemon based on input
    function filterPokemon(inputValue) {
      if (inputValue.length < 2) return [];
      
      const lowerValue = inputValue.toLowerCase();
      return pokemonData.filter(pokemon => 
        pokemon.name.toLowerCase().includes(lowerValue)
      ).slice(0, 10); // Limit to 10 results
    }
    
    // Function to show suggestions
    function showSuggestions(inputEl, suggestionsEl, filteredPokemon) {
      suggestionsEl.innerHTML = '';
      
      if (filteredPokemon.length === 0) {
        suggestionsEl.style.display = 'none';
        return;
      }
      
      filteredPokemon.forEach(pokemon => {
        const item = document.createElement('div');
        item.className = 'suggestion-item';
        if (pokemon.isStrong) {
          item.classList.add('strong-pokemon');
          item.innerHTML = `${pokemon.name} <span class="strong-badge">‚ö° Strong</span>`;
        } else {
          item.textContent = pokemon.name;
        }
        item.dataset.id = pokemon.id;
        item.dataset.name = pokemon.name;
        item.dataset.number = pokemon.number;
        item.dataset.isStrong = pokemon.isStrong;
        suggestionsEl.appendChild(item);
      });
      
      suggestionsEl.style.display = 'block';
    }
    
    // Function to update preview
    function updatePreview(previewEl, pokemon) {
      const staticPath = "{% static 'pokemon-images-index/' %}";
      previewEl.innerHTML = `
        <div class="preview-container">
          <img src="${staticPath}${pokemon.id}.png" alt="${pokemon.name}">
        </div>
      `;
    }
    
    // Function to set selected pokemon
    function selectPokemon(inputEl, hiddenInputEl, selectedEl, previewEl, pokemon) {
      inputEl.value = pokemon.name;
      hiddenInputEl.value = pokemon.id;
      selectedEl.textContent = `Selected: ${pokemon.name}`;
      selectedEl.style.display = 'block';
      updatePreview(previewEl, pokemon);
      
      // Enable best match button if first pokemon is selected
      if (hiddenInputEl === hiddenInput1) {
        bestMatchBtn.disabled = false;
        vsIndicator.style.display = 'block';
      }
      
      // Check if both Pokemon are selected to enable battle button
      if (hiddenInput1.value && hiddenInput2.value) {
        battleButton.disabled = false;
      }
    }
    
    // Best Match functionality
    bestMatchBtn.addEventListener('click', async function() {
      const pokemon1Id = hiddenInput1.value;
      if (!pokemon1Id) {
        alert('Please select first Pokemon first');
        return;
      }
      
      // Update button state
      bestMatchBtn.textContent = 'üîç Finding Best Match...';
      bestMatchBtn.classList.add('best-match-loading');
      bestMatchBtn.disabled = true;
      matchInfo.style.display = 'none';
      
      try {
        const response = await fetch(`/battle/best-match/?pokemon_id=${pokemon1Id}`);
        const data = await response.json();
        
        if (data.success && data.best_match) {
          const bestMatch = data.best_match;
          
          // Auto-select the best match as Pokemon 2
          const pokemon = {
            id: bestMatch.id,
            name: bestMatch.name,
            number: bestMatch.number
          };
          
          selectPokemon(input2, hiddenInput2, selectedPokemon2, preview2, pokemon);
          
          // Show match info
          matchInfo.innerHTML = `
            <strong>Best Match Found!</strong><br>
            ${bestMatch.name} has been selected as your opponent.
            ${bestMatch.strength !== 'N/A' ? `<br>Match Strength: ${parseFloat(bestMatch.strength).toFixed(2)}` : ''}
          `;
          matchInfo.classList.remove('error-info');
          matchInfo.style.display = 'block';
          
        } else {
          matchInfo.innerHTML = `
            <strong>No optimal match found</strong><br>
            ${data.error || 'Please select a Pokemon manually.'}
          `;
          matchInfo.classList.add('error-info');
          matchInfo.style.display = 'block';
        }
        
      } catch (error) {
        console.error('Error finding best match:', error);
        matchInfo.innerHTML = `
          <strong>Error</strong><br>
          Failed to find best match. Please try again or select manually.
        `;
        matchInfo.classList.add('error-info');
        matchInfo.style.display = 'block';
      }
      
      // Reset button state
      bestMatchBtn.textContent = 'üéØ Find Best Match';
      bestMatchBtn.classList.remove('best-match-loading');
      bestMatchBtn.disabled = !hiddenInput1.value;
    });
    
    // Event listener for input1
    input1.addEventListener('input', function() {
      const filteredPokemon = filterPokemon(this.value);
      showSuggestions(this, suggestions1, filteredPokemon);
      
      // Clear selected pokemon if input changes
      if (this.value !== selectedPokemon1.textContent.replace('Selected: ', '').trim()) {
        hiddenInput1.value = '';
        selectedPokemon1.style.display = 'none';
        preview1.innerHTML = '';
        bestMatchBtn.disabled = true;
        matchInfo.style.display = 'none';
        vsIndicator.style.display = 'none';
        battleButton.disabled = true;
      }
    });
    
    // Event listener for input2
    input2.addEventListener('input', function() {
      const filteredPokemon = filterPokemon(this.value);
      showSuggestions(this, suggestions2, filteredPokemon);
      
      // Clear selected pokemon if input changes
      if (this.value !== selectedPokemon2.textContent.replace('Selected: ', '').trim()) {
        hiddenInput2.value = '';
        selectedPokemon2.style.display = 'none';
        preview2.innerHTML = '';
        battleButton.disabled = true;
      }
    });
    
    // Event delegation for suggestion1 clicks
    suggestions1.addEventListener('click', function(e) {
      const item = e.target.closest('.suggestion-item');
      if (item) {
        const pokemon = {
          id: item.dataset.id,
          name: item.dataset.name,
          number: item.dataset.number
        };
        selectPokemon(input1, hiddenInput1, selectedPokemon1, preview1, pokemon);
        suggestions1.style.display = 'none';
      }
    });
    
    // Event delegation for suggestion2 clicks
    suggestions2.addEventListener('click', function(e) {
      const item = e.target.closest('.suggestion-item');
      if (item) {
        const pokemon = {
          id: item.dataset.id,
          name: item.dataset.name,
          number: item.dataset.number
        };
        selectPokemon(input2, hiddenInput2, selectedPokemon2, preview2, pokemon);
        suggestions2.style.display = 'none';
      }
    });
    
    // Hide suggestions when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.selection-input-container')) {
        suggestions1.style.display = 'none';
        suggestions2.style.display = 'none';
      }
    });
    
    // Prevent form submission if Pokemon aren't selected
    document.getElementById('pokemon-selection-form').addEventListener('submit', function(e) {
      if (!hiddenInput1.value || !hiddenInput2.value) {
        e.preventDefault();
        alert('Please select both Pok√©mon from the suggestions');
      }
    });
  });
</script>
{% endblock %}